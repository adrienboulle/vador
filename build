#!/bin/bash

modulesCount=$(ls -l node_modules | wc -l)
env=''
wcdn=''

if [ "$modulesCount" -le 1 ]; then
  npm install
fi

rm -rf aot/
rm -rf .build/

while getopts ue: opt
do
  case "$opt" in
    u) wcdn='true'
    ;;
    e) env=$OPTARG
    ;;
  esac
done

if [ "$wcdn" = "true" ]; then
  while true; do
    read -p "Do you really want to upload assets to CDN? (y/n) " yn
    case $yn in
      [Yy]*)
        break
        ;;
      [Nn]*)
        exit
        ;;
      *)
        echo "Please answer yes or no."
        ;;
    esac
  done
fi

case "$env" in
  "prod" | "production")
    echo "Build environment 'prod'";
    node_modules/.bin/ngc -p tsconfig-aot.json
    node_modules/.bin/rollup -c rollup-config.js

    gulp prod;

    if [ "$wcdn" = 'true' ]; then
      NODE_ENV=production gulp upload
    fi
    ;;
  "-h" | *)
    echo "$0 -e {prod|local}"
esac
